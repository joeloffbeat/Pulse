# Prompt 3: Pyth Auto-Resolution Worker

**Priority:** P1
**Focus:** Backend / Oracle Integration
**Skill Required:** Load `move-dev` skill for contract interaction

---

## Pre-Flight Checklist

1. **Read issues first:** Check `docs/issues/move/README.md` and `docs/issues/indexer/README.md`
2. **Verify Pyth service exists:**
   ```bash
   cat mobile/expo-backend/services/pyth.js
   ```
3. **Check oracle.move contract:**
   ```bash
   cat contracts/sources/oracle.move
   ```

---

## Context

The Pyth price service at `mobile/expo-backend/services/pyth.js` can fetch prices, but there's no worker that:
1. Monitors markets approaching resolution time
2. Fetches Pyth price at resolution time
3. Calls the contract to resolve the market

Markets with `OracleSource::PythPrice` should auto-resolve when their `resolution_time` is reached.

---

## Requirements

### 1. Create Resolution Worker

Create `mobile/expo-backend/workers/resolution-worker.js`:

```javascript
/**
 * Resolution Worker
 *
 * Runs every minute to check for markets ready to resolve.
 * For Pyth oracle markets, fetches price and resolves on-chain.
 */

import { getPrice, getPriceUpdateData, PRICE_FEEDS } from '../services/pyth.js';
import { Aptos, AptosConfig, Network } from '@aptos-labs/ts-sdk';

const POLL_INTERVAL = 60_000; // 1 minute
const MODULE_ADDRESS = process.env.MODULE_ADDRESS;

async function checkAndResolveMarkets() {
  // 1. Fetch active markets with resolution_time <= now
  // 2. For each market with PythPrice oracle:
  //    a. Get current price from Pyth
  //    b. Compare to threshold
  //    c. Call resolve_market_with_oracle()
  // 3. Log results
}

// Start worker
setInterval(checkAndResolveMarkets, POLL_INTERVAL);
checkAndResolveMarkets(); // Run immediately on start
```

### 2. Add Market Query Endpoint

If not exists, add to `mobile/expo-backend/routes/index.js`:

```javascript
// GET /markets/pending-resolution
// Returns markets where resolution_time <= now && !settled
app.get('/markets/pending-resolution', async (req, res) => {
  // Query contract for pending markets
});
```

### 3. Add Resolution Endpoint

```javascript
// POST /markets/:id/resolve-oracle
// Resolves a market using Pyth oracle
app.post('/markets/:id/resolve-oracle', async (req, res) => {
  const { id } = req.params;
  // 1. Verify market exists and uses Pyth oracle
  // 2. Get price update VAA from Pyth
  // 3. Submit resolution transaction
  // 4. Return result
});
```

### 4. Integration with Contract

Ensure the `oracle.move` contract has a function callable by the backend:

```move
public entry fun resolve_market_with_price(
    admin: &signer,
    market_id: u64,
    pyth_price_update: vector<u8>,
) acquires Market, OracleConfig {
    // Verify admin is authorized oracle resolver
    // Verify price update
    // Resolve market based on price vs threshold
}
```

---

## Implementation Steps

1. **Read existing services** - Understand pyth.js and markets.js
2. **Create resolution worker** - Polling logic
3. **Add pending markets query** - From contract or indexer
4. **Implement resolution logic** - Price fetch → comparison → resolve
5. **Add npm script** - To start worker separately
6. **Test with testnet market** - Create market, wait for resolution

---

## Verification

```bash
# Start the worker
cd mobile/expo-backend && node workers/resolution-worker.js

# Check logs for:
# - "Checking for markets to resolve..."
# - "Found N markets pending resolution"
# - "Resolved market X with outcome Y"
```

Create a test market with short resolution time:
```bash
# Create market resolving in 5 minutes
./scripts/create-btc-market.sh --resolution-time $(date -v+5M +%s)

# Wait 5 minutes, check if auto-resolved
./scripts/list-markets.sh
```

---

## Do NOT

- Run resolution worker on mainnet without testing
- Modify existing contract functions (add new ones if needed)
- Store private keys in code (use env vars)
- Skip error handling for failed resolutions

---

## Deliverables

1. `mobile/expo-backend/workers/resolution-worker.js`
2. New endpoint `/markets/pending-resolution`
3. New endpoint `/markets/:id/resolve-oracle`
4. npm script to run worker: `npm run worker:resolution`
5. Working auto-resolution on testnet

---

## Post-Completion

1. Document any oracle/contract issues in `docs/issues/move/README.md`
2. Delete this prompt file: `rm prompts/3.md`
3. Report: "completed prompt 3"

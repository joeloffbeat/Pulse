# Prompt 2: Deep Link Navigation

**Priority:** P1
**Focus:** Mobile Navigation
**Skill Required:** None (standard React Native/Expo Router)

---

## Pre-Flight Checklist

1. **Read issues first:** Check `docs/issues/movement/README.md` for wallet-related issues
2. **Locate the TODO:**
   ```bash
   grep -n "TODO" mobile/app/_layout.tsx
   ```
   Should find line ~30: "Navigate to appropriate screen based on path"

---

## Context

The app supports deep links but the navigation logic is incomplete. Currently at `mobile/app/_layout.tsx:30`, there's a TODO for handling deep link routing.

**Deep link format:**
- `pulse://market/{marketId}` - Open specific market
- `pulse://ref/{code}` - Apply referral code
- `pulse://bets` - Go to My Bets tab
- `pulse://profile` - Go to Profile tab

---

## Requirements

### 1. Implement Deep Link Handler

In `mobile/app/_layout.tsx`, complete the `handleDeepLink` function:

```typescript
const handleDeepLink = ({ url }: { url: string }) => {
  const { path, queryParams } = Linking.parse(url);

  if (!path) return;

  const segments = path.split('/').filter(Boolean);

  if (segments[0] === 'market' && segments[1]) {
    // Navigate to feed and open specific market
    router.push(`/(tabs)?marketId=${segments[1]}`);
  } else if (segments[0] === 'ref' && segments[1]) {
    // Store referral code and continue to onboarding
    AsyncStorage.setItem('referral_code', segments[1]);
  } else if (segments[0] === 'bets') {
    router.push('/(tabs)/bets');
  } else if (segments[0] === 'profile') {
    router.push('/(tabs)/profile');
  }
};
```

### 2. Handle Market Deep Link on Feed

In `mobile/app/(tabs)/index.tsx`:
- Check for `marketId` query param on mount
- If present, scroll to / highlight that market in the stack
- Or show it as a modal

### 3. Handle Referral Code on Signup

In the onboarding or first bet flow:
- Check AsyncStorage for stored referral code
- Pass to backend when placing first bet
- Clear after use

### 4. Configure App Scheme

Verify `app.json` has correct scheme:

```json
{
  "expo": {
    "scheme": "pulse",
    "ios": {
      "associatedDomains": ["applinks:pulse.app"]
    },
    "android": {
      "intentFilters": [...]
    }
  }
}
```

---

## Implementation Steps

1. **Read _layout.tsx** - Understand current structure
2. **Import router from expo-router** - For navigation
3. **Implement handleDeepLink** - Handle all path cases
4. **Update feed screen** - Handle marketId param
5. **Update onboarding hook** - Check for referral code
6. **Test deep links** - Use Expo CLI

---

## Verification

```bash
# Test deep link in development
npx uri-scheme open "pulse://market/1" --ios
npx uri-scheme open "pulse://ref/ABC123" --ios
npx uri-scheme open "pulse://bets" --ios
```

Manual verification:
- [ ] `pulse://market/1` opens the app and shows market 1
- [ ] `pulse://ref/CODE` stores referral code
- [ ] `pulse://bets` navigates to My Bets tab
- [ ] `pulse://profile` navigates to Profile tab
- [ ] Cold start with deep link works
- [ ] Warm start with deep link works

---

## Do NOT

- Change the existing UI layout
- Add new screens
- Modify how markets are displayed (beyond highlighting)
- Break existing navigation

---

## Deliverables

1. Completed `handleDeepLink` function in `_layout.tsx`
2. Feed screen handles `marketId` param
3. Referral code storage and retrieval
4. Working deep links for all defined paths

---

## Post-Completion

1. Document any issues in `docs/issues/ui/README.md`
2. Delete this prompt file: `rm prompts/2.md`
3. Report: "completed prompt 2"

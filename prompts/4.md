# Prompt 4: Free $1 Credit System

**Priority:** P0 (Critical for MVP)
**Focus:** Full-stack (Contract + Backend + Mobile)
**Skill Required:** Load `move-dev` skill for contract work

---

## Pre-Flight Checklist

1. **Read issues first:** Check all `docs/issues/*/README.md` files
2. **Check treasury contract:**
   ```bash
   grep -n "welcome_bonus\|credit\|free" contracts/sources/treasury.move
   ```
3. **Check onboarding flow:**
   ```bash
   cat mobile/components/onboarding/OnboardingScreen.tsx
   ```

---

## Context

Per PRD, new users should receive a $1 welcome credit to start betting. This requires:
1. Contract support for credits/bonuses
2. Backend to track eligible users
3. Frontend to show credit balance and use for bets

---

## Requirements

### 1. Contract: Add Welcome Bonus Support

In `contracts/sources/treasury.move`, add:

```move
/// Track welcome bonus per user
struct WelcomeBonus has key {
    amount: u64,          // Current bonus balance (in smallest unit)
    claimed: bool,        // Whether initial bonus was claimed
    used: u64,            // Amount of bonus used
}

const WELCOME_BONUS_AMOUNT: u64 = 1_000_000; // $1 in 6 decimals

/// Claim welcome bonus (one-time per address)
public entry fun claim_welcome_bonus(user: &signer) acquires WelcomeBonus {
    let user_addr = signer::address_of(user);
    assert!(!exists<WelcomeBonus>(user_addr), E_BONUS_ALREADY_CLAIMED);

    move_to(user, WelcomeBonus {
        amount: WELCOME_BONUS_AMOUNT,
        claimed: true,
        used: 0,
    });
}

/// Use bonus for bet (called internally by place_bet)
public(friend) fun use_bonus(user_addr: address, amount: u64): u64 acquires WelcomeBonus {
    if (!exists<WelcomeBonus>(user_addr)) return 0;

    let bonus = borrow_global_mut<WelcomeBonus>(user_addr);
    let available = bonus.amount - bonus.used;
    let to_use = if (amount <= available) amount else available;

    bonus.used = bonus.used + to_use;
    to_use
}

#[view]
public fun get_bonus_balance(user_addr: address): u64 acquires WelcomeBonus {
    if (!exists<WelcomeBonus>(user_addr)) return 0;
    let bonus = borrow_global<WelcomeBonus>(user_addr);
    bonus.amount - bonus.used
}
```

### 2. Update Position Module

In `contracts/sources/position.move`, modify `place_bet` to:
1. Check user's bonus balance
2. Apply bonus first before requiring real tokens
3. Track how much of bet came from bonus

### 3. Backend: Bonus Endpoints

Add to `mobile/expo-backend/routes/index.js`:

```javascript
// POST /bonus/claim
// Claims welcome bonus for authenticated user
app.post('/bonus/claim', async (req, res) => {
    // Verify user is authenticated (Privy)
    // Check if bonus already claimed
    // Submit claim transaction
});

// GET /bonus/:address
// Get user's current bonus balance
app.get('/bonus/:address', async (req, res) => {
    // Query contract for bonus balance
});
```

### 4. Mobile: Display Bonus

Update relevant components:

1. **Onboarding completion** - Auto-claim bonus after tutorial
2. **Balance display** - Show bonus separately: "$1.00 bonus"
3. **BetModal** - Show bonus being applied: "Using $0.50 bonus"
4. **Profile** - Show bonus balance

### 5. Hook: useBonus

Create `mobile/hooks/useBonus.ts`:

```typescript
export function useBonus() {
  // Query bonus balance
  // Claim bonus function
  // Track bonus usage in bets

  return {
    bonusBalance,
    hasClaimed,
    claimBonus,
    isClaimingLonus,
  };
}
```

---

## Implementation Steps

1. **Update treasury.move** - Add bonus structs and functions
2. **Update position.move** - Integrate bonus into place_bet
3. **Redeploy contracts** - To testnet
4. **Add backend endpoints** - Claim and query
5. **Create useBonus hook** - Frontend integration
6. **Update onboarding** - Auto-claim on completion
7. **Update BetModal** - Show bonus usage
8. **Update profile** - Display bonus balance
9. **Test full flow** - New user → bonus → bet

---

## Verification

```bash
# Verify contract has bonus functions
grep -n "welcome_bonus\|claim_bonus" contracts/sources/treasury.move

# Test bonus claim
curl -X POST http://localhost:3000/bonus/claim \
  -H "Content-Type: application/json" \
  -d '{"address": "0x..."}'

# Check bonus balance
curl http://localhost:3000/bonus/0x...
```

Manual verification:
- [ ] New user completes onboarding
- [ ] $1 bonus appears in balance
- [ ] User can place bet using bonus
- [ ] Bonus decreases after bet
- [ ] Real token used after bonus exhausted
- [ ] Bonus cannot be claimed twice

---

## Do NOT

- Allow bonus to be withdrawn as real tokens
- Give bonus to existing users (new users only)
- Allow bonus transfer between users
- Create complex bonus mechanics (keep simple for MVP)

---

## Deliverables

1. Updated `treasury.move` with bonus support
2. Updated `position.move` to use bonus
3. Backend endpoints for bonus claim/query
4. `useBonus` hook in mobile
5. Updated onboarding to auto-claim
6. UI showing bonus in balance and bet modal
7. Contract redeployed to testnet

---

## Post-Completion

1. Document any contract issues in `docs/issues/move/README.md`
2. Delete this prompt file: `rm prompts/4.md`
3. Report: "completed prompt 4"
